[{"content":"Java å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½å®æµ‹ï¼šåŸºäº JMH çš„å¾®åŸºå‡†æµ‹è¯• åœ¨ Java å¼€å‘ä¸­ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œæ— å¤„ä¸åœ¨ã€‚ä½ å¯èƒ½ä¼šç›´æ¥ä½¿ç”¨ +ï¼Œä¹Ÿå¯èƒ½é€‰æ‹© StringBuilder æˆ– StringBufferã€‚å®ƒä»¬åœ¨æ€§èƒ½ä¸Šç©¶ç«Ÿæœ‰ä½•å·®åˆ«ï¼Ÿåœ¨å¾ªç¯ä¸­æ‹¼æ¥å¤šä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå“ªç§æ–¹å¼æ›´é«˜æ•ˆï¼Ÿ\næœ¬æ–‡åŸºäº JMHï¼ˆJava Microbenchmark Harnessï¼‰è¿›è¡Œäº†ç³»ç»Ÿæ€§æµ‹è¯•ï¼Œå¹¶ä½¿ç”¨ GitHub Actions åœ¨ Ubuntu ç¯å¢ƒä¸­å®æµ‹äº†ä¸åŒå­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼çš„æ€§èƒ½ã€‚\nğŸ§ª æµ‹è¯•ç›®æ ‡ æ¯”è¾ƒä»¥ä¸‹ä¸‰ç§æ‹¼æ¥æ–¹å¼åœ¨é«˜é¢‘åœºæ™¯ä¸‹çš„æ€§èƒ½å·®å¼‚ï¼š\n+ æ“ä½œç¬¦ï¼ˆè¯­æ³•ç³–ï¼Œç¼–è¯‘æœŸè½¬ä¸º StringBuilder.appendï¼‰ StringBuilder.append StringBuffer.append ğŸ§° é¡¹ç›®åˆ›å»ºä¸é…ç½®ï¼ˆMavenï¼‰ 1. åˆ›å»ºåŸºç¡€å·¥ç¨‹ 1 2 3 4 5 mvn archetype:generate \\ -DgroupId=com.xinchentechnote \\ -DartifactId=string-jmh \\ -DarchetypeArtifactId=maven-archetype-quickstart \\ -DinteractiveMode=false 2. é…ç½® pom.xml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openjdk.jmh\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jmh-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.37\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.openjdk.jmh\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jmh-generator-annprocess\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.37\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.8.1\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;source\u0026gt;17\u0026lt;/source\u0026gt; \u0026lt;target\u0026gt;17\u0026lt;/target\u0026gt; \u0026lt;annotationProcessorPaths\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;org.openjdk.jmh\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jmh-generator-annprocess\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.37\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;/annotationProcessorPaths\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; ğŸ“„ æµ‹è¯•ä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package com.xinchentechnote; import org.openjdk.jmh.annotations.*; import java.util.concurrent.TimeUnit; @BenchmarkMode({Mode.Throughput, Mode.AverageTime}) @OutputTimeUnit(TimeUnit.MICROSECONDS) @State(Scope.Thread) public class StringConcatBenchmark { private String str1 = \u0026#34;Hello\u0026#34;; private String str2 = \u0026#34;World\u0026#34;; private String str3 = \u0026#34;Java\u0026#34;; private int count = 100; @Benchmark public String testStringBuilder() { StringBuilder sb = new StringBuilder(); for (int i = 0; i \u0026lt; count; i++) { sb.append(str1); sb.append(str2); sb.append(str3); } return sb.toString(); } @Benchmark public String testStringBuffer() { StringBuffer sb = new StringBuffer(); for (int i = 0; i \u0026lt; count; i++) { sb.append(str1); sb.append(str2); sb.append(str3); } return sb.toString(); } @Benchmark public String testStringPlus() { String result = \u0026#34;\u0026#34;; for (int i = 0; i \u0026lt; count; i++) { result += str1; result += str2; result += str3; } return result; } } ğŸš€ GitHub Actions è‡ªåŠ¨åŒ–æµ‹è¯•é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 name: JMH Benchmarks on: workflow_dispatch: jobs: benchmark: runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - uses: actions/setup-java@v3 with: distribution: temurin java-version: \u0026#39;17\u0026#39; cache: maven - run: mvn clean install -DskipTests - run: java -jar target/benchmarks.jar StringConcatBenchmark ğŸ“Š å®æµ‹ç»“æœï¼ˆUbuntu + GitHub Actionsï¼‰ ğŸ“ˆ ååé‡æµ‹è¯•ï¼ˆThroughputï¼‰ å•ä½ï¼šæ¯å¾®ç§’æ‰§è¡Œçš„æ“ä½œæ•°ï¼ˆops/usï¼‰\næ–¹æ³• ååé‡ StringBuilder 0.478 ops/us StringBuffer 0.448 ops/us + æ“ä½œç¬¦ ğŸš« 0.199 ops/us â± å¹³å‡è€—æ—¶æµ‹è¯•ï¼ˆAverageTimeï¼‰ å•ä½ï¼šæ¯æ¬¡æ“ä½œçš„å¹³å‡è€—æ—¶ï¼ˆus/opï¼‰\næ–¹æ³• å¹³å‡è€—æ—¶ StringBuilder 2.021 us/op StringBuffer 2.237 us/op + æ“ä½œç¬¦ ğŸš« 5.244 us/op ğŸ” åŸç†è§£æ StringBuilderï¼šéçº¿ç¨‹å®‰å…¨ä½†æ€§èƒ½æœ€å¥½ï¼Œæ¨èåœ¨å¾ªç¯ä¸­ä½¿ç”¨ã€‚ StringBufferï¼šçº¿ç¨‹å®‰å…¨ä½†æ€§èƒ½ç•¥ä½ã€‚ + æ“ä½œç¬¦ï¼šè™½ç„¶ç›´è§‚ï¼Œä½†åœ¨å¾ªç¯ä¸­æå…¶ä½æ•ˆï¼Œä¼šé¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼Œå¸¦æ¥ GC å‹åŠ›ã€‚ âœ… ä½¿ç”¨å»ºè®® æ‹¼æ¥æ–¹å¼ ä¼˜ç‚¹ ç¼ºç‚¹ æ¨èåœºæ™¯ StringBuilder æ€§èƒ½æœ€ä½³ éçº¿ç¨‹å®‰å…¨ å•çº¿ç¨‹é«˜é¢‘æ‹¼æ¥ StringBuffer çº¿ç¨‹å®‰å…¨ æ€§èƒ½ç•¥å·® å¤šçº¿ç¨‹æ‹¼æ¥åœºæ™¯ + æ“ä½œç¬¦ ç®€æ´ç›´è§‚ æ…¢ä¸” GC å‹åŠ›å¤§ ä½é¢‘ç®€æ˜“æ‹¼æ¥ ğŸ æ€»ç»“ æœ¬æ¬¡ JMH å®æµ‹éªŒè¯äº†å¼€å‘ç»éªŒä¸­çš„æœ€ä½³å®è·µï¼šåœ¨é«˜é¢‘åœºæ™¯ä¸­ï¼Œæ¨èä½¿ç”¨ StringBuilder è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ã€‚\nğŸ’¡ JMH å°çŸ¥è¯†ï¼šJava å¾®åŸºå‡†æµ‹è¯•åˆ©å™¨ JMH (Java Microbenchmark Harness) æ˜¯ç”± Oracle å’Œ OpenJDK å›¢é˜Ÿä¸“ä¸º Java ç¼–å†™çš„å¾®åŸºå‡†æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºè¡¡é‡ Java æ–¹æ³•åœ¨çº³ç§’åˆ°å¾®ç§’çº§åˆ«çš„æ€§èƒ½è¡¨ç°ã€‚JMH ç‰¹åˆ«é€‚ç”¨äºéœ€è¦ç²¾ç»†åˆ†ææ–¹æ³•è°ƒç”¨å¼€é”€ã€ç¼–è¯‘ä¼˜åŒ–ã€å‰¯ä½œç”¨ç­‰å¯¹æ€§èƒ½å½±å“çš„åœºæ™¯ã€‚\næ ¸å¿ƒæœ¯è¯­ä¸æ³¨è§£è§£é‡Šï¼š æ³¨è§£æˆ–å‚æ•° å«ä¹‰ @Benchmark æ ‡è®°è¦è¢«æµ‹è¯•çš„æ–¹æ³•ã€‚æ¯æ¬¡è¿è¡Œéƒ½è°ƒç”¨å®ƒå¹¶æ”¶é›†æ€§èƒ½æ•°æ®ã€‚ @BenchmarkMode è®¾ç½®åŸºå‡†æµ‹è¯•çš„æ¨¡å¼ï¼ˆå¦‚ååé‡ã€å¹³å‡æ—¶é—´ç­‰ï¼‰ã€‚å¯é€‰å€¼åŒ…æ‹¬ï¼š- Throughput: å•ä½æ—¶é—´å†…æ“ä½œæ¬¡æ•°- AverageTime: æ¯ä¸ªæ“ä½œå¹³å‡è€—æ—¶- SampleTime, SingleShotTime, AllModes @OutputTimeUnit è®¾ç½®è¾“å‡ºç»“æœçš„æ—¶é—´å•ä½ï¼Œå¦‚ TimeUnit.MILLISECONDS æˆ– MICROSECONDSã€‚ @State ç”¨äºç®¡ç†åŸºå‡†æ–¹æ³•æ‰€éœ€çš„çŠ¶æ€å˜é‡ä½œç”¨åŸŸã€‚å¸¸ç”¨ Scope.Thread è¡¨ç¤ºæ¯çº¿ç¨‹ç‹¬ç«‹çŠ¶æ€ã€‚ @Fork è®¾ç½®æ‰§è¡Œå‡ è½® JVM å¯åŠ¨æ¥è§„é¿ JVM çƒ­èº«é˜¶æ®µçš„å½±å“ï¼Œé€šå¸¸è®¾ç½®ä¸º 1~3ã€‚ @Warmup é¢„çƒ­æ¬¡æ•°ä¸æ¯æ¬¡æŒç»­æ—¶é—´ï¼ˆJIT ç¼–è¯‘ä¼˜åŒ–å‘ç”Ÿåœ¨æ­¤é˜¶æ®µï¼‰ã€‚é¿å…å†·å¯åŠ¨å½±å“åŸºå‡†æ•°æ®ã€‚ @Measurement çœŸæ­£é‡‡é›†æ€§èƒ½æ•°æ®çš„æ¬¡æ•°å’ŒæŒç»­æ—¶é—´ã€‚å»ºè®®è‡³å°‘ 5 æ¬¡ Ã— 1s+ã€‚ æ¨èé…ç½®å‚æ•°è¯´æ˜ï¼š 1 2 3 4 5 6 @BenchmarkMode({Mode.Throughput, Mode.AverageTime}) // åŒæ—¶æµ‹ååé‡å’Œå¹³å‡è€—æ—¶ @OutputTimeUnit(TimeUnit.MICROSECONDS) // è¾“å‡ºå¾®ç§’ä¸ºå•ä½ @State(Scope.Thread) // æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çŠ¶æ€ @Fork(1) // å¯åŠ¨ 1 æ¬¡ JVM @Warmup(iterations = 5, time = 1) // é¢„çƒ­ 5 æ¬¡ï¼Œæ¯æ¬¡ 1 ç§’ @Measurement(iterations = 5, time = 1) // é‡‡æ · 5 æ¬¡ï¼Œæ¯æ¬¡ 1 ç§’ ä¸ºä»€ä¹ˆä¸èƒ½ç®€å•ç”¨ System.currentTimeMillisï¼Ÿ å› ä¸º JVM å¯åŠ¨åˆæœŸ JIT ç¼–è¯‘æœªå®Œæˆã€å†…è”å°šæœªå±•å¼€ã€é€ƒé€¸åˆ†æç­‰ä¼˜åŒ–æœºåˆ¶å°šæœªä»‹å…¥ï¼Œåˆå§‹è¿è¡Œçš„è€—æ—¶éå¸¸ä¸ç¨³å®šã€‚è€Œ JMH é€šè¿‡ï¼š\nè‡ªåŠ¨ warm-up é¢„çƒ­é˜¶æ®µï¼›\nå¤šè½® fork JVM éš”ç¦»ä¼˜åŒ–å½±å“ï¼›\nç»Ÿè®¡è¯¯å·®å’Œæ³¢åŠ¨èŒƒå›´ï¼ˆErrorï¼‰ï¼›\nç¡®ä¿äº†æµ‹å¾—ç»“æœæ›´çœŸå®ã€æ›´æ¥è¿‘åº”ç”¨å®é™…è¡¨ç°ã€‚\nå¸Œæœ›æœ¬æ–‡èƒ½ä¸ºä½ åœ¨æ—¥å¸¸å¼€å‘ä¸æ€§èƒ½ä¼˜åŒ–ä¸­æä¾›é‡åŒ–å‚è€ƒï¼\n","date":"2025-05-11T10:29:30+08:00","permalink":"https://xinchentechnote.github.io/note/p/java-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B%E5%9F%BA%E4%BA%8E-jmh-%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/","title":"Java å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½å®æµ‹ï¼šåŸºäº JMH çš„å¾®åŸºå‡†æµ‹è¯•"}]